<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel="stylesheet" href="/style.css">
  </head>
  <body>
    <div id="page">
        <div class="room-container">
            <div id="room-name">
                <div>Room Name: <span class="name"></span> User Name:  <span class="user"></span></div>
            </div>
            <div id="wrapper1">
                <ul id="messages"></ul>
            </div>
            <div id="wrapper2">
                <div>Room List</div>
                <ul id="room-list">

                </ul>
            </div>
            <div>
                <form id="chat-room" action="javascript:void(0)">
                    <input id="message" />
                    <button id="send">发送</button>
                </form>
            </div>
        </div>
        <div class="join-container">
            <form id="join-room" action="javascript:void(0)">
                <input id="roomID" placeholder="房间名（默认值：Lobby）" />
                <button id="join">加入</button>
            </form>
        </div>
    </div>

    <script src="./config/index.js"></script>
    <script src="/jquery-1.11.1.js"></script>
    <script>
        let tcbClientWS = null;
        let wsHost = `${window.location.host}`;

        if (!!~wsHost.indexOf('localhost')) {
            wsHost = `http://${wsHost}`;
        }
        else {
            wsHost = `https://${wsHost}`;
        }

        $('#join').on('click', async () => {
            tcbClientWS = new TcbClientWS(wsHost, {
                query: {
                    token: token
                }
            });
            tcbClientWS.open();

            let roomInput = $('#roomID');
            let roomID = roomInput.val() || 'Lobby';
            roomInput.val('');

            processMessage(tcbClientWS);
            sendMessage(tcbClientWS);
            updateRoomlist(tcbClientWS);

            try {
                await tcbClientWS.join(roomID);
                updateCurrentRoom(roomID);
            }
            catch(e) {
                alert(e);
            }
            $('.join-container').hide();
        });


    </script>

    <script src="./websocket-javascript-sdk/index.js"></script>
    <script>
        console.log(window.TcbClientWS);
        function updateCurrentRoom(roomID) {
            $('#room-name .name').text(roomID);
        }

        function updateUserName(username) {
            $('#room-name .user').text(username);
        }

        function sendMessage(tcbClientWS) {
            $('#send').on('click', async () => {
                let msgInput = $('#message');
                let message = msgInput.val();
                msgInput.val('');
                await tcbClientWS.send({
                    event: 'message',
                    message,
                });
            });
        }

        function processMessage(tcbClientWS) {
            tcbClientWS.receive({
                event: 'message',
                callback: (data) => {
                    let nickName = data.nickName;
                    let type = data.type;
                    let value = data.value;
                    let isSelf = data.isSelf;

                    switch (type) {
                        case 'join': {
                            $('#messages').append($('<li class="new-user"></li>').text(`System Message: ${nickName} ${value}`));

                            if (isSelf) {
                                updateUserName(nickName);
                            }

                            break;
                        }
                        case 'exit': {
                            $('#messages').append($('<li class="exit-user"></li>').text(`System Message: ${nickName} ${value}`));
                            break;
                        }
                        case 'message': {
                            let obj = null;

                            if (isSelf) {
                                obj = $('#messages').append($('<li class="chat-message right"><span class="text"></span><img class="avatar" src="' + data.avatarUrl + '" /></li>'));
                            }
                            else {
                                obj = $('#messages').append($('<li class="chat-message left"><img class="avatar" src="' + data.avatarUrl + '" /><span class="text"></span></li>'));
                            }

                            $(obj).children('.chat-message').children('.text').last().text(value);
                            break;
                        }
                    }
                }
            });
        }

        function updateRoomlist(tcbClientWS) {
            tcbClientWS.receive({
                event: 'room-list',
                callback: (data) => {
                    // console.log(data);
                    let rooms = Object.keys(data);
                    let tags = '';

                    rooms.forEach((item) => {
                        tags += `<li data-room="${item}" class="room-list-item">${item}</li>`;
                    });

                    $('#room-list').html(tags);
                }
            });

            $('#room-list').on('click', async (e) => {
                let data = e.target.dataset;
                let roomID = data.room;
                await tcbClientWS.join(roomID);
                updateCurrentRoom(roomID);
            });
        }
    </script>
  </body>
</html>
